<!DOCTYPE html>

<html>
<head>
  <title>redis-timeseries-storage.js</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, target-densitydpi=160dpi, initial-scale=1.0; maximum-scale=1.0; user-scalable=0;">
  <link rel="stylesheet" media="all" href="docco.css" />
</head>
<body>
  <div id="container">
    <div id="background"></div>
    
      <ul id="jump_to">
        <li>
          <a class="large" href="javascript:void(0);">Jump To &hellip;</a>
          <a class="small" href="javascript:void(0);">+</a>
          <div id="jump_wrapper">
          <div id="jump_page">
            
              
              <a class="source" href="display-view-mixin.html">
                display-view-mixin.js
              </a>
            
              
              <a class="source" href="gallery.html">
                gallery.js
              </a>
            
              
              <a class="source" href="json-socket-connection.html">
                json-socket-connection.js
              </a>
            
              
              <a class="source" href="polyfill-request-animation-frame.html">
                polyfill-request-animation-frame.js
              </a>
            
              
              <a class="source" href="social.html">
                social.js
              </a>
            
              
              <a class="source" href="touch-event-view-mixin.html">
                touch-event-view-mixin.js
              </a>
            
              
              <a class="source" href="viewport-size.html">
                viewport-size.js
              </a>
            
              
              <a class="source" href="wrapped-context.html">
                wrapped-context.js
              </a>
            
              
              <a class="source" href="z-Index-stack.html">
                z-Index-stack.js
              </a>
            
              
              <a class="source" href="color-util.html">
                color-util.js
              </a>
            
              
              <a class="source" href="hsl-gradient.html">
                hsl-gradient.js
              </a>
            
              
              <a class="source" href="bind.html">
                bind.js
              </a>
            
              
              <a class="source" href="clone.html">
                clone.js
              </a>
            
              
              <a class="source" href="counted-callback-mixin.html">
                counted-callback-mixin.js
              </a>
            
              
              <a class="source" href="ctor.html">
                ctor.js
              </a>
            
              
              <a class="source" href="each.html">
                each.js
              </a>
            
              
              <a class="source" href="event-mixin.html">
                event-mixin.js
              </a>
            
              
              <a class="source" href="extend.html">
                extend.js
              </a>
            
              
              <a class="source" href="inherits.html">
                inherits.js
              </a>
            
              
              <a class="source" href="list.html">
                list.js
              </a>
            
              
              <a class="source" href="loop.html">
                loop.js
              </a>
            
              
              <a class="source" href="middleware.html">
                middleware.js
              </a>
            
              
              <a class="source" href="object.html">
                object.js
              </a>
            
              
              <a class="source" href="router 2.html">
                router 2.js
              </a>
            
              
              <a class="source" href="router 3.html">
                router 3.js
              </a>
            
              
              <a class="source" href="router 4.html">
                router 4.js
              </a>
            
              
              <a class="source" href="router.html">
                router.js
              </a>
            
              
              <a class="source" href="sequence.html">
                sequence.js
              </a>
            
              
              <a class="source" href="tick-timer.html">
                tick-timer.js
              </a>
            
              
              <a class="source" href="timer.html">
                timer.js
              </a>
            
              
              <a class="source" href="angleBetween.html">
                angleBetween.js
              </a>
            
              
              <a class="source" href="clamp.html">
                clamp.js
              </a>
            
              
              <a class="source" href="clipNormalized.html">
                clipNormalized.js
              </a>
            
              
              <a class="source" href="close.html">
                close.js
              </a>
            
              
              <a class="source" href="colorStringToHex.html">
                colorStringToHex.js
              </a>
            
              
              <a class="source" href="colorValuesToHex.html">
                colorValuesToHex.js
              </a>
            
              
              <a class="source" href="distance.html">
                distance.js
              </a>
            
              
              <a class="source" href="dynamicEaseInterpolation.html">
                dynamicEaseInterpolation.js
              </a>
            
              
              <a class="source" href="fitScaleRatio.html">
                fitScaleRatio.js
              </a>
            
              
              <a class="source" href="floatToString.html">
                floatToString.js
              </a>
            
              
              <a class="source" href="hexStringToColorArray.html">
                hexStringToColorArray.js
              </a>
            
              
              <a class="source" href="inRange.html">
                inRange.js
              </a>
            
              
              <a class="source" href="interpolation.html">
                interpolation.js
              </a>
            
              
              <a class="source" href="lerp.html">
                lerp.js
              </a>
            
              
              <a class="source" href="map.html">
                map.js
              </a>
            
              
              <a class="source" href="maths.html">
                maths.js
              </a>
            
              
              <a class="source" href="normalize.html">
                normalize.js
              </a>
            
              
              <a class="source" href="randomBetween.html">
                randomBetween.js
              </a>
            
              
              <a class="source" href="shuffleArray.html">
                shuffleArray.js
              </a>
            
              
              <a class="source" href="cors-middleware.html">
                cors-middleware.js
              </a>
            
              
              <a class="source" href="geolocate.html">
                geolocate.js
              </a>
            
              
              <a class="source" href="jade-middleware.html">
                jade-middleware.js
              </a>
            
              
              <a class="source" href="json-socket-connection 2.html">
                json-socket-connection 2.js
              </a>
            
              
              <a class="source" href="json-socket-connection.html">
                json-socket-connection.js
              </a>
            
              
              <a class="source" href="live-reload.html">
                live-reload.js
              </a>
            
              
              <a class="source" href="referrer-storage.html">
                referrer-storage.js
              </a>
            
              
              <a class="source" href="ws-repeater.html">
                ws-repeater.js
              </a>
            
              
              <a class="source" href="redis-set-storage.html">
                redis-set-storage.js
              </a>
            
              
              <a class="source" href="redis-timeseries-storage.html">
                redis-timeseries-storage.js
              </a>
            
          </div>
        </li>
      </ul>
    
    <ul class="sections">
        
          <li id="title">
              <div class="annotation">
                  <h1>redis-timeseries-storage.js</h1>
              </div>
          </li>
        
        
        
        <li id="section-1">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-1">&#182;</a>
              </div>
              <p>Stores counts of a list of values.</p>
<p>Keys are stored at the following resolution:</p>
<ul>
<li>minutes for the 120 minutes</li>
<li>hours for the 120 hours</li>
<li>days for the last 120 days</li>
<li>weeks for the last 120 weeks</li>
</ul>
<p>The storage is time independant in that key counts are not expressed in “from date” and “to date” but “from time ago” to “time ago”. This avoid server and request time differences.</p>
<p>Next idea…. set up caching, so that once a day has pass, the minutes are stored in a cache of arrays.</p>

            </div>
            
        </li>
        
        
        <li id="section-2">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-2">&#182;</a>
              </div>
              <h2 id="config">Config</h2>

            </div>
            
            <div class="content"><div class='highlight'><pre>
<span class="hljs-keyword">var</span> MAX_KEYS = <span class="hljs-number">120</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-3">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-3">&#182;</a>
              </div>
              <h2 id="time-utilites">Time Utilites</h2>

            </div>
            
        </li>
        
        
        <li id="section-4">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-4">&#182;</a>
              </div>
              <p>Reference date.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">var</span> EPOCH = <span class="hljs-number">1379425660487</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-5">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-5">&#182;</a>
              </div>
              <p>Seconds.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">var</span> SECS_PER_MIN = <span class="hljs-number">60</span>;
<span class="hljs-keyword">var</span> SECS_PER_HOUR = <span class="hljs-number">60</span> * SECS_PER_MIN;
<span class="hljs-keyword">var</span> SECS_PER_DAY = <span class="hljs-number">24</span> * SECS_PER_HOUR;
<span class="hljs-keyword">var</span> SECS_PER_WEEK = <span class="hljs-number">7</span> * SECS_PER_DAY;</pre></div></div>
            
        </li>
        
        
        <li id="section-6">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-6">&#182;</a>
              </div>
              <p>Milliseconds.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">var</span> MS_PER_SEC = <span class="hljs-number">1000</span>;
<span class="hljs-keyword">var</span> MS_PER_MIN = SECS_PER_MIN * MS_PER_SEC;
<span class="hljs-keyword">var</span> MS_PER_HOUR = SECS_PER_HOUR * MS_PER_SEC;
<span class="hljs-keyword">var</span> MS_PER_DAY = SECS_PER_DAY * MS_PER_SEC;
<span class="hljs-keyword">var</span> MS_PER_WEEK = SECS_PER_WEEK * MS_PER_SEC;

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">getMinutesSinceEpoch</span> <span class="hljs-params">()</span> {</span>
    <span class="hljs-keyword">return</span> <span class="hljs-built_in">Math</span>.floor( (<span class="hljs-built_in">Date</span>.now() - EPOCH) / MS_PER_MIN );
}

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">getHoursSinceEpoch</span> <span class="hljs-params">()</span> {</span>
    <span class="hljs-keyword">return</span> <span class="hljs-built_in">Math</span>.floor( (<span class="hljs-built_in">Date</span>.now() - EPOCH) / MS_PER_HOUR );
}

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">getDaysSinceEpoch</span> <span class="hljs-params">()</span> {</span>
    <span class="hljs-keyword">return</span> <span class="hljs-built_in">Math</span>.floor( (<span class="hljs-built_in">Date</span>.now() - EPOCH) / MS_PER_DAY );
}

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">getWeeksSinceEpoch</span> <span class="hljs-params">()</span> {</span>
    <span class="hljs-keyword">return</span> <span class="hljs-built_in">Math</span>.floor( (<span class="hljs-built_in">Date</span>.now() - EPOCH) / MS_PER_WEEK );
}</pre></div></div>
            
        </li>
        
        
        <li id="section-7">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-7">&#182;</a>
              </div>
              <h2 id="redis-incrementors">Redis incrementors</h2>

            </div>
            
        </li>
        
        
        <li id="section-8">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-8">&#182;</a>
              </div>
              <p>Main function to increment a key.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">increment</span><span class="hljs-params">(redisClient, amount, keyPrepend, key, callback)</span> {</span>

    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> amount !== <span class="hljs-string">'number'</span>) {
        callback(<span class="hljs-string">"increment amount is not number"</span>);
        <span class="hljs-keyword">return</span>;
    }

    <span class="hljs-keyword">var</span> multi = redisClient.multi();</pre></div></div>
            
        </li>
        
        
        <li id="section-9">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-9">&#182;</a>
              </div>
              <p>Chain each redis command.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    incrementMinute(multi, amount, keyPrepend, key);
    incrementHour(multi, amount, keyPrepend, key);
    incrementDays(multi, amount, keyPrepend, key);
    incrementWeeks(multi, amount, keyPrepend, key);</pre></div></div>
            
        </li>
        
        
        <li id="section-10">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-10">&#182;</a>
              </div>
              <p>Do it</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    multi.exec(callback);

}

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">incrementMinute</span><span class="hljs-params">(redisMutli, amount, keyPrepend, key)</span> {</span>
    <span class="hljs-keyword">var</span> fullKey = keyPrepend+<span class="hljs-string">"m:"</span>+getMinutesSinceEpoch()+<span class="hljs-string">":"</span>+key;
    <span class="hljs-keyword">if</span> (amount === <span class="hljs-number">1</span>) { redisMutli.incr( fullKey ); } 
    <span class="hljs-keyword">else</span> { redisMutli.incrby( fullKey, amount ); }
    redisMutli.expire( fullKey, SECS_PER_MIN * MAX_KEYS );
}

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">incrementHour</span><span class="hljs-params">(redisMutli, amount, keyPrepend, key)</span> {</span>
    <span class="hljs-keyword">var</span> fullKey = keyPrepend+<span class="hljs-string">"h:"</span>+getHoursSinceEpoch()+<span class="hljs-string">":"</span>+key;
    <span class="hljs-keyword">if</span> (amount === <span class="hljs-number">1</span>) { redisMutli.incr( fullKey ); } 
    <span class="hljs-keyword">else</span> { redisMutli.incrby( fullKey, amount ); }
    redisMutli.expire( fullKey, SECS_PER_HOUR * MAX_KEYS );
}

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">incrementDays</span><span class="hljs-params">(redisMutli, amount, keyPrepend, key)</span> {</span>
    <span class="hljs-keyword">var</span> fullKey = keyPrepend+<span class="hljs-string">"d:"</span>+getDaysSinceEpoch()+<span class="hljs-string">":"</span>+key;
    <span class="hljs-keyword">if</span> (amount === <span class="hljs-number">1</span>) { redisMutli.incr( fullKey ); } 
    <span class="hljs-keyword">else</span> { redisMutli.incrby( fullKey, amount ); }
    redisMutli.expire( fullKey, SECS_PER_DAY * MAX_KEYS );
}

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">incrementWeeks</span><span class="hljs-params">(redisMutli, amount, keyPrepend, key)</span> {</span>
    <span class="hljs-keyword">var</span> fullKey = keyPrepend+<span class="hljs-string">"w:"</span>+getWeeksSinceEpoch()+<span class="hljs-string">":"</span>+key;
    <span class="hljs-keyword">if</span> (amount === <span class="hljs-number">1</span>) { redisMutli.incr( fullKey ); } 
    <span class="hljs-keyword">else</span> { redisMutli.incrby( fullKey, amount ); }
    redisMutli.expire( fullKey, SECS_PER_WEEK * MAX_KEYS );
}</pre></div></div>
            
        </li>
        
        
        <li id="section-11">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-11">&#182;</a>
              </div>
              <h2 id="redis-getters">Redis getters</h2>

            </div>
            
            <div class="content"><div class='highlight'><pre>
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">countMinutes</span><span class="hljs-params">(redisClient,  keyPrepend, key, callback)</span> {</span>
    <span class="hljs-keyword">var</span> multi = redisClient.multi();
    <span class="hljs-keyword">var</span> currentTimeKey = getMinutesSinceEpoch();
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = currentTimeKey; i &gt; currentTimeKey-MAX_KEYS; --i ) {
        multi.get(keyPrepend+<span class="hljs-string">"m:"</span>+i+<span class="hljs-string">":"</span>+key);
    }
    multi.exec(callback);
}

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">countHours</span><span class="hljs-params">(redisClient,  keyPrepend, key, callback)</span> {</span>
    <span class="hljs-keyword">var</span> multi = redisClient.multi();
    <span class="hljs-keyword">var</span> currentTimeKey = getHoursSinceEpoch();
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = currentTimeKey; i &gt; currentTimeKey-MAX_KEYS; --i ) {
        multi.get(keyPrepend+<span class="hljs-string">"h:"</span>+i+<span class="hljs-string">":"</span>+key);
    }
    multi.exec(callback);
}

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">countDays</span><span class="hljs-params">(redisClient,  keyPrepend, key, callback)</span> {</span>
    <span class="hljs-keyword">var</span> multi = redisClient.multi();
    <span class="hljs-keyword">var</span> currentTimeKey = getDaysSinceEpoch();
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = currentTimeKey; i &gt; currentTimeKey-MAX_KEYS; --i ) {
        multi.get(keyPrepend+<span class="hljs-string">"d:"</span>+i+<span class="hljs-string">":"</span>+key);
    }
    multi.exec(callback);
}

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">countWeeks</span><span class="hljs-params">(redisClient,  keyPrepend, key, callback)</span> {</span>
    <span class="hljs-keyword">var</span> multi = redisClient.multi();
    <span class="hljs-keyword">var</span> currentTimeKey = getWeeksSinceEpoch();
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = currentTimeKey; i &gt; currentTimeKey-MAX_KEYS; --i ) {
        multi.get(keyPrepend+<span class="hljs-string">"w:"</span>+i+<span class="hljs-string">":"</span>+key);
    }
    multi.exec(callback);
}</pre></div></div>
            
        </li>
        
        
        <li id="section-12">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-12">&#182;</a>
              </div>
              <h2 id="redistimeseriesstorage">RedisTimeseriesStorage</h2>

            </div>
            
        </li>
        
        
        <li id="section-13">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-13">&#182;</a>
              </div>
              <p>Constructor.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">RedisTimeseriesStorage</span> <span class="hljs-params">(options)</span> {</span>
    <span class="hljs-keyword">this</span>.redisClient = options.redisClient;
    <span class="hljs-keyword">this</span>.keyPrepend = <span class="hljs-string">"js:tss:"</span>;
    <span class="hljs-keyword">if</span> (options.key) {
        <span class="hljs-keyword">this</span>.keyPrepend += options.key+<span class="hljs-string">":"</span>;
    }
}</pre></div></div>
            
        </li>
        
        
        <li id="section-14">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-14">&#182;</a>
              </div>
              <p>resolutions</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>
RedisTimeseriesStorage.RES_MINUTE   = <span class="hljs-string">"minute"</span>;
RedisTimeseriesStorage.RES_HOUR     = <span class="hljs-string">"hour"</span>;
RedisTimeseriesStorage.RES_DAY      = <span class="hljs-string">"day"</span>;
RedisTimeseriesStorage.RES_WEEK     = <span class="hljs-string">"week"</span>;

RedisTimeseriesStorage.prototype.increment = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(key, callback)</span> {</span>
    key = key.toLowerCase();
    increment(<span class="hljs-keyword">this</span>.redisClient, <span class="hljs-number">1</span>, <span class="hljs-keyword">this</span>.keyPrepend, key, callback);
};

RedisTimeseriesStorage.prototype.incrementBy = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(key, amount, callback)</span> {</span>
    key = key.toLowerCase();
    increment(<span class="hljs-keyword">this</span>.redisClient, amount, <span class="hljs-keyword">this</span>.keyPrepend, key, callback);
};

RedisTimeseriesStorage.prototype.count = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(key, resolution, callback)</span> {</span>
    key = key.toLowerCase();
    <span class="hljs-keyword">switch</span> (resolution) {
        <span class="hljs-keyword">case</span> RedisTimeseriesStorage.RES_MINUTE:
            countMinutes(<span class="hljs-keyword">this</span>.redisClient, <span class="hljs-keyword">this</span>.keyPrepend, key, callback);
            <span class="hljs-keyword">break</span>;
        <span class="hljs-keyword">case</span> RedisTimeseriesStorage.RES_HOUR:
            countHours(<span class="hljs-keyword">this</span>.redisClient, <span class="hljs-keyword">this</span>.keyPrepend, key, callback);
            <span class="hljs-keyword">break</span>;
        <span class="hljs-keyword">case</span> RedisTimeseriesStorage.RES_DAY:
            countDays(<span class="hljs-keyword">this</span>.redisClient, <span class="hljs-keyword">this</span>.keyPrepend, key, callback);
            <span class="hljs-keyword">break</span>;
        <span class="hljs-keyword">case</span> RedisTimeseriesStorage.RES_WEEK:
            countWeeks(<span class="hljs-keyword">this</span>.redisClient, <span class="hljs-keyword">this</span>.keyPrepend, key, callback);
            <span class="hljs-keyword">break</span>;
        <span class="hljs-keyword">default</span>:
            callback(<span class="hljs-string">"RedisTimeseriesStorage::count Error: no resolution provided"</span>);
            <span class="hljs-keyword">break</span>;
    }
};</pre></div></div>
            
        </li>
        
        
        <li id="section-15">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-15">&#182;</a>
              </div>
              <h2 id="export">Export</h2>

            </div>
            
            <div class="content"><div class='highlight'><pre>
module.exports = RedisTimeseriesStorage;</pre></div></div>
            
        </li>
        
    </ul>
  </div>
</body>
</html>
