<!DOCTYPE html>

<html>
<head>
  <title>router.js</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, target-densitydpi=160dpi, initial-scale=1.0; maximum-scale=1.0; user-scalable=0;">
  <link rel="stylesheet" media="all" href="docco.css" />
</head>
<body>
  <div id="container">
    <div id="background"></div>
    
      <ul id="jump_to">
        <li>
          <a class="large" href="javascript:void(0);">Jump To &hellip;</a>
          <a class="small" href="javascript:void(0);">+</a>
          <div id="jump_wrapper">
          <div id="jump_page">
            
              
              <a class="source" href="_.footer.html">
                _.footer.js
              </a>
            
              
              <a class="source" href="_.header.html">
                _.header.js
              </a>
            
              
              <a class="source" href="bind.html">
                bind.js
              </a>
            
              
              <a class="source" href="clone.html">
                clone.js
              </a>
            
              
              <a class="source" href="counted-callback-mixin.html">
                counted-callback-mixin.js
              </a>
            
              
              <a class="source" href="each.html">
                each.js
              </a>
            
              
              <a class="source" href="event-mixin.html">
                event-mixin.js
              </a>
            
              
              <a class="source" href="extend.html">
                extend.js
              </a>
            
              
              <a class="source" href="flip.html">
                flip.js
              </a>
            
              
              <a class="source" href="interpose.html">
                interpose.js
              </a>
            
              
              <a class="source" href="is-not-ok.html">
                is-not-ok.js
              </a>
            
              
              <a class="source" href="is-ok.html">
                is-ok.js
              </a>
            
              
              <a class="source" href="list.html">
                list.js
              </a>
            
              
              <a class="source" href="loop.html">
                loop.js
              </a>
            
              
              <a class="source" href="middleware.html">
                middleware.js
              </a>
            
              
              <a class="source" href="object.html">
                object.js
              </a>
            
              
              <a class="source" href="partial.html">
                partial.js
              </a>
            
              
              <a class="source" href="router.html">
                router.js
              </a>
            
              
              <a class="source" href="sequence.html">
                sequence.js
              </a>
            
              
              <a class="source" href="tick-timer.html">
                tick-timer.js
              </a>
            
              
              <a class="source" href="timer.html">
                timer.js
              </a>
            
          </div>
        </li>
      </ul>
    
    <ul class="sections">
        
          <li id="title">
              <div class="annotation">
                  <h1>router.js</h1>
              </div>
          </li>
        
        
        
        <li id="section-1">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-1">&#182;</a>
              </div>
              <p>Inspired by express.js and path.js</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">var</span> noOp = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span>{</span>};</pre></div></div>
            
        </li>
        
        
        <li id="section-2">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-2">&#182;</a>
              </div>
              <h1 id="router">Router</h1>
<p><em>Note the router is async and will never trigger synchronously.</em></p>
<h2 id="example">Example</h2>
<h3 id="setup">Setup</h3>
<pre><code><span class="hljs-keyword">var</span> router = <span class="hljs-keyword">new</span> Router();
router
    .map( <span class="hljs-string">'/a/:b/'</span> )
        .to( <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">( route, next )</span> {</span>
            next();
        })
        .to( <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">( route )</span> {</span>
            console.log( <span class="hljs-string">"b"</span>, route.params.b );
        })
    .map( <span class="hljs-string">'/a/:b/:c'</span>, <span class="hljs-string">'GET'</span> )
        .to( <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">( route )</span> {</span>

        })
    .map( <span class="hljs-string">'/a/:b/:c'</span>, [ <span class="hljs-string">'POST'</span>, <span class="hljs-string">'PUT'</span> ] )
        .to( <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">( route )</span> {</span>

        })
    .map( <span class="hljs-string">'extra args'</span> )
        .to( <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">( route, x, y, z )</span> {</span>

        })
    .noRoute( <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">( route, extra )</span> {</span>
        console.log( <span class="hljs-string">'no route for'</span>, route.path );
    });
</code></pre><h3 id="triggering">Triggering</h3>
<p>With <code>onDone</code> as trigger will happen in next tick </p>
<pre><code>router.trigger( <span class="hljs-string">'/a/10/'</span> ).onDone( <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> {</span>} );
</code></pre><p>With method</p>
<pre><code>router.trigger( <span class="hljs-string">'/a/1/2/'</span> ).withMethod( <span class="hljs-string">'GET'</span> );
</code></pre><p>With extra arguments</p>
<pre><code>router.trigger( <span class="hljs-string">'/a/1/2/'</span>, <span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span> );
</code></pre>
            </div>
            
            <div class="content"><div class='highlight'><pre>
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">Router</span> <span class="hljs-params">()</span> {</span>
    <span class="hljs-keyword">this</span>.routes = [];
    <span class="hljs-keyword">this</span>.noMatch = <span class="hljs-literal">null</span>;
}</pre></div></div>
            
        </li>
        
        
        <li id="section-3">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-3">&#182;</a>
              </div>
              <h2 id="trigger">Trigger</h2>
<p>Arguments:</p>
<ul>
<li>path <String:URL/Pattern></li>
<li>argsâ€¦</li>
</ul>

            </div>
            
            <div class="content"><div class='highlight'><pre>Router.prototype.trigger = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(path)</span> {</span>
    <span class="hljs-keyword">var</span> self = <span class="hljs-keyword">this</span>;
    <span class="hljs-keyword">var</span> triggerArguments = <span class="hljs-built_in">arguments</span>;
    
    
    <span class="hljs-keyword">var</span> promise = <span class="hljs-keyword">new</span> RouterTriggerPromise(noOp,noOp);

    setTimeout((<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(promise)</span> {</span>
        <span class="hljs-keyword">return</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> {</span></pre></div></div>
            
        </li>
        
        
        <li id="section-4">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-4">&#182;</a>
              </div>
              <p>Route detection</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="hljs-keyword">var</span> matchingRoute;
            <span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>;
            <span class="hljs-keyword">while</span> ( i &lt; self.routes.length ) {
                <span class="hljs-keyword">if</span> ( self.routes[i].method === promise.method &amp;&amp; self.routes[i].match(path) ) {
                    matchingRoute = self.routes[i];
                    <span class="hljs-keyword">break</span>;
                }
                ++i;
            }
            <span class="hljs-keyword">if</span> (matchingRoute) {
                W.loop(matchingRoute.callbacks.length, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(i, next, end)</span> {</span>
                    <span class="hljs-keyword">var</span> callback = matchingRoute.callbacks[i];</pre></div></div>
            
        </li>
        
        
        <li id="section-5">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-5">&#182;</a>
              </div>
              <p>convert the array with keys back to an object</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                    <span class="hljs-keyword">var</span> route = {
                        method : promise.method,
                        params : {},
                        path : path
                    };
                    <span class="hljs-built_in">Object</span>.keys(matchingRoute.params).forEach(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(key)</span> {</span>
                        route.params[key] = matchingRoute.params[key];
                    });
                    <span class="hljs-keyword">var</span> args = [route];
                    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> j=<span class="hljs-number">1</span>; j&lt;triggerArguments.length; j++) {
                        args.push(triggerArguments[j]);
                    }
                    args.push(next);
                    callback.apply(<span class="hljs-keyword">this</span>, args);
                }, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> {</span>
                    promise.allCallbacksDidNext();
                });
                promise.done();
            } <span class="hljs-keyword">else</span> {
                <span class="hljs-keyword">var</span> route = {
                    method : promise.method,
                    params : {},
                    path : path
                };
                <span class="hljs-keyword">var</span> args = [route];
                <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> j=<span class="hljs-number">1</span>; j&lt;triggerArguments.length; j++) {
                    args.push(triggerArguments[j]);
                }
                self.noMatch.apply(<span class="hljs-keyword">this</span>, args);
                promise.done();
            }
        };
    }(promise)),<span class="hljs-number">0</span>);

    <span class="hljs-keyword">return</span> promise;
};

Router.prototype.map = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">( path, methods )</span> {</span>
    <span class="hljs-keyword">var</span> routerContext = <span class="hljs-keyword">this</span>;
    <span class="hljs-keyword">var</span> routes = [];

    <span class="hljs-keyword">if</span> ( <span class="hljs-keyword">typeof</span> methods === <span class="hljs-string">'undefined'</span> || methods === <span class="hljs-literal">null</span> ) { methods = [<span class="hljs-string">'none'</span>]; }
    <span class="hljs-keyword">if</span> ( <span class="hljs-keyword">typeof</span> methods === <span class="hljs-string">'string'</span> ) { methods = [methods]; } 

    methods.forEach(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(method)</span> {</span>   
        routes.push( <span class="hljs-keyword">new</span> Route(method, path, [], {sensitive:<span class="hljs-literal">true</span>, strict:<span class="hljs-literal">true</span>}) );
    });

    <span class="hljs-keyword">this</span>.routes = <span class="hljs-keyword">this</span>.routes.concat(routes);

    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> RouterMapPromise(routes, routerContext);

};

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">RouterTriggerPromise</span><span class="hljs-params">(allCallbacksDidNext, onNoMatch)</span> {</span>
    <span class="hljs-keyword">this</span>.allCallbacksDidNext = allCallbacksDidNext;
    <span class="hljs-keyword">this</span>.onAllCallbacksDidNext = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">( fn )</span> {</span>
        <span class="hljs-keyword">this</span>.allCallbacksDidNext = fn;
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>;
    };
    <span class="hljs-keyword">this</span>.done = noOp;
    <span class="hljs-keyword">this</span>.onDone = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">( fn )</span> {</span>
        <span class="hljs-keyword">this</span>.done = fn;
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>;
    };
    <span class="hljs-keyword">this</span>.method = <span class="hljs-string">'none'</span>;
    <span class="hljs-keyword">this</span>.withMethod = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">( method )</span> {</span>
        <span class="hljs-keyword">this</span>.method = method;
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>;
    };
}

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">RouterMapPromise</span><span class="hljs-params">(routes, routerContext)</span> {</span>
    <span class="hljs-keyword">var</span> self = <span class="hljs-keyword">this</span>;
    <span class="hljs-keyword">this</span>.to = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(fn)</span> {</span>
        routes.forEach(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(route)</span> {</span>
            route.callbacks.push(fn);
        });
        <span class="hljs-keyword">return</span> self;
    };
    <span class="hljs-keyword">this</span>.toWhenMethod = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(method, fn)</span> {</span>
        routes.forEach(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(route)</span> {</span>
            route.callbacks.push(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(req)</span> {</span>
                <span class="hljs-keyword">if</span> ( req.method === method ) {
                    fn.apply( <span class="hljs-keyword">this</span>, <span class="hljs-built_in">arguments</span> );
                } <span class="hljs-keyword">else</span> {</pre></div></div>
            
        </li>
        
        
        <li id="section-6">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-6">&#182;</a>
              </div>
              <p>take the last argument, which is next and call it</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                    <span class="hljs-built_in">arguments</span>[ <span class="hljs-built_in">arguments</span>.length-<span class="hljs-number">1</span> ]();
                }
            });
        });
        <span class="hljs-keyword">return</span> self;
    };
    <span class="hljs-keyword">this</span>.map = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> {</span>
        <span class="hljs-keyword">return</span> routerContext.map.apply(routerContext, <span class="hljs-built_in">arguments</span>);
    };
    <span class="hljs-keyword">this</span>.trigger = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> {</span>
        <span class="hljs-keyword">return</span> routerContext.trigger.apply(routerContext, <span class="hljs-built_in">arguments</span>);
    };
    <span class="hljs-keyword">this</span>.noMatch = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">( fn )</span> {</span>
        routerContext.noMatch = fn;
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>;
    };
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>;
}

<span class="hljs-comment">/**
 * Initialize `Route` with the given HTTP `method`, `path`,
 * and an array of `callbacks` and `options`.
 *
 * Options:
 *
 *   - `sensitive`    enable case-sensitive routes
 *   - `strict`       enable strict matching for trailing slashes
 *
 * @param {String} method
 * @param {String} path
 * @param {Array} callbacks
 * @param {Object} options.
 * @api private
 */</span>

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">Route</span><span class="hljs-params">(method, path, callbacks, options)</span> {</span>
  options = options || {};
  <span class="hljs-keyword">this</span>.path = path;
  <span class="hljs-keyword">this</span>.method = method;
  <span class="hljs-keyword">this</span>.callbacks = callbacks;
  <span class="hljs-keyword">this</span>.regexp = pathRegexp(path, <span class="hljs-keyword">this</span>.keys = [], options.sensitive, options.strict);
}

<span class="hljs-comment">/**
 * Check if this route matches `path`, if so
 * populate `.params`.
 *
 * @param {String} path
 * @return {Boolean}
 * @api private
 */</span>

Route.prototype.match = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(path)</span>{</span>
    <span class="hljs-keyword">var</span> keys = <span class="hljs-keyword">this</span>.keys;
    <span class="hljs-keyword">var</span> params = <span class="hljs-keyword">this</span>.params = [];
    <span class="hljs-keyword">var</span> m = <span class="hljs-keyword">this</span>.regexp.exec(path);

    <span class="hljs-keyword">if</span> (!m) <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;

    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = <span class="hljs-number">1</span>, len = m.length; i &lt; len; ++i) {
        <span class="hljs-keyword">var</span> key = keys[i - <span class="hljs-number">1</span>];

        <span class="hljs-keyword">var</span> val = <span class="hljs-string">'string'</span> == <span class="hljs-keyword">typeof</span> m[i] ? <span class="hljs-built_in">decodeURIComponent</span>(m[i]) : m[i];

        <span class="hljs-keyword">if</span> (key) {
            params[key.name] = val;
        } <span class="hljs-keyword">else</span> {
            params.push(val);
        }
  }

  <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
};</pre></div></div>
            
        </li>
        
        
        <li id="section-7">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-7">&#182;</a>
              </div>
              <p>Borrowed from express utils</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">pathRegexp</span><span class="hljs-params">(path, keys, sensitive, strict)</span> {</span>
    <span class="hljs-keyword">if</span> (toString.call(path) == <span class="hljs-string">'[object RegExp]'</span>) <span class="hljs-keyword">return</span> path;
    <span class="hljs-keyword">if</span> (<span class="hljs-built_in">Array</span>.isArray(path)) path = <span class="hljs-string">'('</span> + path.join(<span class="hljs-string">'|'</span>) + <span class="hljs-string">')'</span>;
    path = path
        .concat(strict ? <span class="hljs-string">''</span> : <span class="hljs-string">'/?'</span>)
        .replace(<span class="hljs-regexp">/\/\(/g</span>, <span class="hljs-string">'(?:/'</span>)
        .replace(<span class="hljs-regexp">/(\/)?(\.)?:(\w+)(?:(\(.*?\)))?(\?)?(\*)?/g</span>, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(_, slash, format, key, capture, optional, star)</span>{</span>
            keys.push({ name: key, optional: !! optional });
            slash = slash || <span class="hljs-string">''</span>;
            <span class="hljs-keyword">return</span> <span class="hljs-string">''</span>
                + (optional ? <span class="hljs-string">''</span> : slash)
                + <span class="hljs-string">'(?:'</span>
                + (optional ? slash : <span class="hljs-string">''</span>)
                + (format || <span class="hljs-string">''</span>) + (capture || (format &amp;&amp; <span class="hljs-string">'([^/.]+?)'</span> || <span class="hljs-string">'([^/]+?)'</span>)) + <span class="hljs-string">')'</span>
                + (optional || <span class="hljs-string">''</span>)
                + (star ? <span class="hljs-string">'(/*)?'</span> : <span class="hljs-string">''</span>);
        })
        .replace(<span class="hljs-regexp">/([\/.])/g</span>, <span class="hljs-string">'\\$1'</span>)
        .replace(<span class="hljs-regexp">/\*/g</span>, <span class="hljs-string">'(.*)'</span>);
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">RegExp</span>(<span class="hljs-string">'^'</span> + path + <span class="hljs-string">'$'</span>, sensitive ? <span class="hljs-string">''</span> : <span class="hljs-string">'i'</span>);
}</pre></div></div>
            
        </li>
        
    </ul>
  </div>
</body>
</html>
